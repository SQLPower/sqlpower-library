<project name="sqlpower_library" default="dist" basedir=".">

	<!-- $Id$ -->
	<property name="dist.dir" value="dist"/>
	<property name="src" value="src"/>
	<property name="build" value="build"/>
	<property name="build.compiler" value="modern"/>
	<property name="dist.jar" value="sqlpower_library.jar"/>
	<property name="tests" value="regress"/>

	<path id="compile.classpath">
		<fileset dir="lib">
			<include name="*.jar"/>
		</fileset>
	</path>

	<path id="test.classpath">
		<pathelement location="${build}"/>
		<fileset dir="lib">
			<include name="*.jar"/>
		</fileset>
	</path>
	
	<target name="init">
		<tstamp/>
		<mkdir dir="${build}"/>
	</target>

	<target name="compile" depends="init">
		<javac srcdir="${src}" destdir="${build}" classpathref="compile.classpath" debug="true"/>
		<copy tofile="${build}/ca/sqlpower/sql/default_database_types.ini"
				     file="src/ca/sqlpower/sql/default_database_types.ini"/>
		<copy todir="${build}/">
			<fileset dir="src">
				<include name="**/messages*.properties"/>
			</fileset>
		</copy>
	</target>

	<target name="compile-tests" depends="compile">
		<property name="build.tests" value="${build}/tests"/>
		<mkdir dir="${build.tests}"/>
		<javac srcdir="${tests}" destdir="${build.tests}" classpathref="test.classpath" debug="true"/>
	</target>
	
	<target name="test" depends="compile-tests">
		<property name="reports.junit" value="${dist.dir}/reports/junit"/>
		<mkdir dir="${reports.junit}"/>
		<!-- Output all System.out and System.err messages -->
	   <junit printsummary="on" showoutput="no">
	   	   <sysproperty key="ca.sqlpower.architect.test.dir" value="${build.tests}"/>
	       <classpath>
	       		<path refid="test.classpath"/>
	       		<path path="${build.tests}"/>
	       </classpath>
	       <test name="LibraryMegaTest" todir="${reports.junit}"/>
	   	   <formatter type="xml"/>
	   </junit>
		<!-- Generate HTML report -->
		<junitreport todir="${reports.junit}">
		  <fileset dir="${reports.junit}">
		    <include name="TEST-*.xml" />
		  </fileset>
		  <report todir="${reports.junit}" />
		</junitreport>
	</target>
	
	<target name="jar" depends="compile, test">
		<jar jarfile="${build}/${dist.jar}" basedir="${build}" 
			includes="META-INF/*,ca/**">
		</jar>
	</target>

	<target name="dist" depends="jar">
		<copy file="${build}/${dist.jar}" todir="${dist.dir}"/>
	</target>

	<target name="clean">
		<delete dir="${build}"/>
	</target>

	<target name="dist-clean" depends="clean">
		<delete dir="${dist.dir}"/>
	</target>
	
	<target name="javadoc" 
		description="Generate the Javadoc documentation for the MatchMaker API"
		depends="compile">
		<mkdir dir="${dist.dir}/doc/api"/>
		<javadoc sourcepath="${src}" destdir="${dist.dir}/doc/api"
			packagenames="ca.sqlpower.*"
			maxmemory="100m"
			windowtitle="ca.sqlpower.* SQL Power Library"
			Version="true" Author="true" Use="true"
			Overview="html/overview.html"
			classpathref="test.classpath"
			>
			<packageset dir="${src}" defaultexcludes="yes">
				<include name="ca/sqlpower/**" />
				<exclude name="regress/**"/>
			</packageset>
			<bottom><![CDATA[<i>Copyright &#169; 2003-2008 SQL Power Group Inc. <a href="http://www.sqlpower.ca/">www.sqlpower.ca</a>]]></bottom>
		</javadoc>
	</target>
	
	<target name="javadoc.with.umlgraph" 
		description="Generate the Javadoc documentation for the MatchMaker API along with UML diagrams generated using UMLGraph"
		depends="compile">
		<mkdir dir="${dist.dir}/doc/api"/>
		<javadoc sourcepath="${src}" destdir="${dist.dir}/doc/api"
			packagenames="ca.sqlpower.*"
			maxmemory="100m"
			windowtitle="ca.sqlpower.* SQL Power Library"
			Version="true" Author="true" Use="true"
			Overview="html/overview.html"
			classpathref="test.classpath"
			>
			<doclet name="gr.spinellis.umlgraph.doclet.UmlGraphDoc"
    		  path="buildlib/UmlGraph.jar">
    	        <param name="-attributes" />
    	        <param name="-operations" />
    	        <param name="-qualify" />
    	        <param name="-types" />
    	        <param name="-visibility" />
    	    </doclet>
			<packageset dir="${src}" defaultexcludes="yes">
				<include name="ca/sqlpower/**" />
				<exclude name="regress/**"/>
			</packageset>
			<bottom><![CDATA[<i>Copyright &#169; 2003-2008 SQL Power Group Inc. <a href="http://www.sqlpower.ca/">www.sqlpower.ca</a>]]></bottom>
		</javadoc>
		
		<apply executable="dot" dest="${dist.dir}/doc" parallel="false">
			<arg value="-Tpng"/>
			<arg value="-o"/>
			<targetfile/>
			<srcfile/>
			<fileset dir="${dist.dir}/doc" includes="*.dot"/>
			<mapper type="glob" from="*.dot" to="*.png"/>
		</apply>
	</target>
</project>
